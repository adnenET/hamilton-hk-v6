<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hamilton HK ‚Äî Technique KPI (OPS V5)</title>
  <style>
    :root{ --bg:#0b0f14; --card:#111826; --muted:#93a4b8; --text:#e7eef7; --line:#1e2a3b; --pri:#2d73ff;
      --ok:#7cf2b5; --warn:#ffd48a; --bad:#ff6b7a; }
    *{ box-sizing:border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body{ margin:0; background:linear-gradient(180deg,#0b0f14,#070a0f); color:var(--text); }
    header{ position:sticky; top:0; z-index:20; background:rgba(11,15,20,.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); }
    .wrap{ max-width:1400px; margin:0 auto; padding:12px 16px; }
    h1{ margin:0; font-size:15px; }
    .sub{ margin-top:4px; font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:7px 10px; border-radius:999px; border:1px solid var(--line); background:#0b1220; font-size:12px; }
    .btn{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#0b1220; color:var(--text); cursor:pointer; }
    .btn.primary{ background:var(--pri); border-color:var(--pri); }
    .btn:hover{ filter:brightness(1.06); }
    .grid{ max-width:1400px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width:1100px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .card{ background:rgba(17,24,38,.92); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .kpis{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .kpi{ display:inline-flex; gap:8px; align-items:center; padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:#0b1220; font-size:12px; }
    .small{ font-size:11px; color:var(--muted); }
    input, select{ width:100%; padding:9px 10px; border-radius:10px; border:1px solid var(--line); background:#0b1220; color:var(--text); outline:none; font-size:12px; }
    .row{ display:grid; grid-template-columns: 1fr 220px; gap:10px; align-items:center; padding:6px 0; border-bottom:1px dashed rgba(30,42,59,.55); }
    .row:last-child{ border-bottom:none; }
    .table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--line); }
    .table th,.table td{ padding:10px 10px; border-bottom:1px solid rgba(30,42,59,.6); vertical-align:top; font-size:12px; }
    .table th{ text-align:left; color:#cfe0ff; background:#0b1220; }
    .table tr:last-child td{ border-bottom:none; }
    .ok{ color:var(--ok);} .warn{ color:var(--warn);} .bad{ color:var(--bad);}
  </style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
    <div>
      <h1>Technique ‚Äî KPIs & Tra√ßabilit√© <span class="pill">OPS V5</span></h1>
      <div class="sub">
        <span class="pill">Tickets ‚Üí performance agents</span>
        <span class="pill">WhatsApp r√©sum√©</span>
      </div>
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn" id="btnTickets">Tickets</button>
      <button class="btn" id="btnTech">Staff technique</button>
      <button class="btn primary" id="btnWhats">WhatsApp ‚Äî r√©sum√©</button>
    </div>
  </div>
</header>

<div class="grid">
  <section class="card">
    <div class="row"><label>P√©riode</label>
      <select id="period"><option value="7">7 jours</option><option value="30" selected>30 jours</option><option value="90">90 jours</option><option value="ALL">Tout</option></select>
    </div>
    <div class="small" id="statusMsg"></div>
    <div class="kpis" id="kpis"></div>
    <div class="small">R√®gle: performance = tickets termin√©s + d√©lai moyen + backlog ouvert.</div>
  </section>

  <section class="card">
    <div style="font-weight:800; font-size:13px; color:#d7e6ff;">Performance par agent technique</div>
    <div style="margin-top:10px; overflow:auto;">
      <table class="table">
        <thead><tr><th>Agent</th><th>Tickets clos</th><th>D√©lai moyen</th><th>Backlog ouvert</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
const $=(id)=>document.getElementById(id);
const LS_TOKEN="hk_token_v5", LS_API="hk_api_url_v5";
function defaultApiUrl(){
  const u=new URL(window.location.href);
  const path=u.pathname.replace(/\/tech_dashboard\.html$/, "/").replace(/\/$/,"/");
  u.pathname=path+"api/api.php"; u.search=""; return u.toString();
}
function getToken(){ return localStorage.getItem(LS_TOKEN)||""; }
function getApiUrl(){ return localStorage.getItem(LS_API)||defaultApiUrl(); }
async function api(action, body=null){
  const url=new URL(getApiUrl()); url.searchParams.set("action", action);
  const headers={"Content-Type":"application/json"}; const t=getToken(); if(t) headers["X-Auth-Token"]=t;
  const res=await fetch(url.toString(), {method: body?"POST":"GET", headers, body: body?JSON.stringify(body):undefined});
  const j=await res.json().catch(()=>null); if(!j||!j.ok) throw new Error(j&&j.error?j.error:"API error"); return j.data;
}
function wa(text){
  window.open("https://wa.me/?text="+encodeURIComponent(text), "_blank");
}
function fmtDur(ms){
  if(!ms || ms<0) return "‚Äî";
  const h = Math.round(ms/360000)/10; // hours with 1 decimal
  if(h<24) return h+" h";
  const d = Math.round(h/24*10)/10;
  return d+" j";
}
const S={tech:null, tickets:[]};

function inPeriod(t){
  const p=$("period").value;
  if(p==="ALL") return true;
  const n=parseInt(p||"30",10);
  const since = new Date(); since.setDate(since.getDate()-n);
  const dt = new Date((t.created_at||t.updated_at||""));
  return dt>=since;
}

function compute(){
  const tech=(S.tech.staff||[]).filter(x=>x.active!==false);
  const tickets=S.tickets.filter(inPeriod);
  const open=tickets.filter(t=>t.status!=="DONE");
  const done=tickets.filter(t=>t.status==="DONE");
  const kpis=$("kpis"); kpis.innerHTML="";
  const mk=(lab,val,cls="")=>{ const d=document.createElement("div"); d.className="kpi"; d.innerHTML=`<span class="small">${lab}</span> <b class="${cls}" style="margin-left:6px;">${val}</b>`; return d; };
  kpis.appendChild(mk("Tickets ouverts", open.length, open.length? "warn": "ok"));
  kpis.appendChild(mk("Tickets clos", done.length, done.length? "ok": ""));
  const avg = done.length ? done.reduce((a,t)=>a + (new Date(t.closed_at||t.updated_at)-new Date(t.created_at||t.updated_at)),0)/done.length : 0;
  kpis.appendChild(mk("D√©lai moyen", fmtDur(avg), avg? "": ""));

  const tbody=$("tbody"); tbody.innerHTML="";
  if(!tech.length){
    const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="4" class="small">Aucun agent technique dans la BD.</td>`; tbody.appendChild(tr);
    return;
  }
  tech.forEach(a=>{
    const my = tickets.filter(t=> (t.assigned_to||"")===a.id);
    const myDone = my.filter(t=>t.status==="DONE");
    const myOpen = my.filter(t=>t.status!=="DONE");
    const myAvg = myDone.length ? myDone.reduce((s,t)=> s + (new Date(t.closed_at||t.updated_at)-new Date(t.created_at||t.updated_at)),0)/myDone.length : 0;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><b>${a.id}</b> ‚Äî ${(a.name||"").trim()} <span class="small">(${a.skill||"General"})</span></td>
      <td><b>${myDone.length}</b></td><td>${fmtDur(myAvg)}</td><td>${myOpen.length}</td>`;
    tbody.appendChild(tr);
  });
}

function formatWhats(){
  const p=$("period").value;
  const label = p==="ALL" ? "Tout" : (p+"j");
  const tickets=S.tickets.filter(inPeriod);
  const open=tickets.filter(t=>t.status!=="DONE");
  const done=tickets.filter(t=>t.status==="DONE");
  const lines=[`üõ†Ô∏è KPI TECHNIQUE ‚Äî P√©riode: ${label}`,
               `Ouverts: ${open.length} | Clos: ${done.length}`,
               ``,
               `Backlog (ouverts):`];
  open.slice(0,25).forEach(t=>{
    lines.push(`‚Ä¢ ${t.id} | Room ${t.room||"-"} | ${t.priority||""} | ${t.category||""} | ${t.assigned_to||"‚Äî"} | ${t.status}`);
  });
  if(open.length>25) lines.push(`‚Ä¶ (+${open.length-25})`);
  return lines.join("\n");
}

async function loadAll(){
  try{
    S.tech = await api("get_tech_roster");
    const tk = await api("get_tickets");
    S.tickets = tk.tickets || [];
    $("statusMsg").innerHTML = `<span class="ok">‚úÖ API connect√©e</span>`;
  }catch(e){
    $("statusMsg").innerHTML = `<span class="warn">‚ö†Ô∏è API non disponible</span>`;
    S.tech={staff:[]}; S.tickets=[];
  }
  compute();
}

$("btnTickets").addEventListener("click", ()=>{ window.location.href="tickets.html"; });
$("btnTech").addEventListener("click", ()=>{ window.location.href="tech_staff.html"; });
$("period").addEventListener("change", compute);
$("btnWhats").addEventListener("click", ()=>{ wa(formatWhats()); });

loadAll();
</script>
</body>
</html>
