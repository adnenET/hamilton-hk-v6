<!doctype html>
<html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hamilton HK - Journal</title>
<style>
body{font-family:system-ui,Arial;margin:0;background:#0b1220;color:#e2e8f0}
header{padding:12px;border-bottom:1px solid #1f2a44;background:#060b14;position:sticky;top:0}
main{max-width:1100px;margin:0 auto;padding:12px}
.card{background:#0f172a;border:1px solid #1f2a44;border-radius:14px;padding:12px;margin-bottom:10px}
input,select{width:100%;padding:10px;border-radius:12px;border:1px solid #1f2a44;background:#0b1220;color:#e2e8f0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{padding:10px 12px;border-radius:12px;border:1px solid #1f2a44;background:#0b1220;color:#e2e8f0;text-decoration:none;display:inline-block}
.btn.primary{background:#1d4ed8;border-color:#1d4ed8}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #1f2a44;font-size:12px;vertical-align:top}
th{text-align:left;color:#cbd5e1}
.small{color:#94a3b8;font-size:12px}
</style></head>
<body>
<header>
  <div class="row" style="max-width:1100px;margin:0 auto">
    <div style="flex:1">
      <b>Journal d’activité (Audit Trail)</b><div class="small">Lecture seule — Admin</div>
    </div>
    <a class="btn" href="index.html#home">Retour</a>
  </div>
</header>
<main>
  <div class="card">
    <div class="row">
      <div style="flex:2">
        <label class="small">Filtrer par action</label>
        <select id="fAction"><option value="">Toutes</option></select>
      </div>
      <div style="flex:1">
        <label class="small">Recherche</label>
        <input id="q" placeholder="room / id / texte...">
      </div>
      <div>
        <label class="small">&nbsp;</label>
        <button class="btn primary" id="reload">Recharger</button>
      </div>
    </div>
    <div class="small" style="margin-top:8px">Le token doit être présent dans le navigateur (stocké lors de l’utilisation de l’app).</div>
  </div>

  <div class="card">
    <table id="t">
      <thead><tr><th>Date</th><th>Action</th><th>Détails</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
const API="api/api.php";
function token(){ return localStorage.getItem("hk_token")||""; }
async function getTrail(){
  const r=await fetch(API+"?action=get_audit_trail",{headers: token()?{"X-Auth-Token":token()}:{}});
  const j=await r.json();
  if(!j.ok) throw new Error(j.error||"Erreur");
  return j.data;
}
function esc(s){return (s??"").toString().replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]));}
function render(events){
  const tb=document.querySelector("#t tbody");
  tb.innerHTML="";
  events.slice().reverse().slice(0,500).forEach(ev=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${esc(ev.ts||"")}</td><td><b>${esc(ev.action||"")}</b></td><td><pre style="white-space:pre-wrap;margin:0">${esc(JSON.stringify(ev.meta||{},null,2))}</pre></td>`;
    tb.appendChild(tr);
  });
}
function fillActions(events){
  const set=new Set(events.map(e=>e.action).filter(Boolean));
  const sel=document.querySelector("#fAction");
  sel.innerHTML='<option value="">Toutes</option>';
  Array.from(set).sort().forEach(a=>{
    const o=document.createElement("option");o.value=a;o.textContent=a;sel.appendChild(o);
  });
}
let all=[];
async function load(){
  const data=await getTrail();
  all=(data && data.events)||[];
  fillActions(all);
  apply();
}
function apply(){
  const act=document.querySelector("#fAction").value;
  const q=(document.querySelector("#q").value||"").toLowerCase();
  let x=all;
  if(act) x=x.filter(e=>e.action===act);
  if(q) x=x.filter(e=>JSON.stringify(e).toLowerCase().includes(q));
  render(x);
}
document.querySelector("#reload").onclick=load;
document.querySelector("#fAction").onchange=apply;
document.querySelector("#q").oninput=apply;
load().catch(e=>alert(e.message));
</script>
</body></html>
