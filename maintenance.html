<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hamilton HK ‚Äî Maintenance (V5 FINAL OPS)</title>
  <style>
    :root{ --bg:#0b0f14; --card:#111826; --muted:#93a4b8; --text:#e7eef7; --line:#1e2a3b; --pri:#2d73ff; }
    *{ box-sizing:border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body{ margin:0; background:linear-gradient(180deg,#0b0f14,#070a0f); color:var(--text); }
    header{ position:sticky; top:0; z-index:20; background:rgba(11,15,20,.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); }
    .wrap{ max-width:1200px; margin:0 auto; padding:12px 16px; }
    h1{ margin:0; font-size:15px; }
    .sub{ margin-top:4px; font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:7px 10px; border-radius:999px; border:1px solid var(--line); background:#0b1220; font-size:12px; }
    .btn{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#0b1220; color:var(--text); cursor:pointer; }
    .btn.primary{ background:var(--pri); border-color:var(--pri); }
    .btn:hover{ filter:brightness(1.06); }
    .grid{ max-width:1200px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 1fr; gap:12px; }
    .card{ background:rgba(17,24,38,.92); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .small{ font-size:11px; color:var(--muted); }
    .table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--line); }
    .table th,.table td{ padding:10px 10px; border-bottom:1px solid rgba(30,42,59,.6); vertical-align:top; font-size:12px; }
    .table th{ text-align:left; color:#cfe0ff; background:#0b1220; }
    .table tr:last-child td{ border-bottom:none; }
    @media print{ header,.no-print{display:none !important;} body{background:#fff;color:#000;} .card{background:#fff;border:1px solid #ddd;border-radius:0;} .table{border:1px solid #ddd;} .table th{background:#f3f3f3;color:#000;} }
  </style>
</head>
<body>
<header class="no-print">
  <div class="wrap" style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
    <div>
      <h1>Hamilton HK ‚Äî Maintenance <span class="pill">V5 FINAL OPS</span></h1>
      <div class="sub">
        <span class="pill">Liste imprimable</span>
        <span class="pill">Source: demandes actives dans PMS</span>
      </div>
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn" id="btnBack">‚Üê PMS</button>
      <button class="btn primary" id="btnPrint">Imprimer</button>
      <button class="btn" id="btnRefresh">Rafra√Æchir</button>
      <button class="btn" id="btnWhats">WhatsApp</button>
    </div>
  </div>
</header>

<div class="grid">
  <section class="card">
    <div class="small" id="statusMsg"></div>
    <div style="margin-top:10px; overflow:auto;">
      <table class="table">
        <thead><tr><th>Room</th><th>Probl√®me</th><th>Statut</th><th>Commentaire</th></tr></thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
const $=(id)=>document.getElementById(id);
const LS_TOKEN="hk_token_v5", LS_API="hk_api_url_v5";
function defaultApiUrl(){
  const u=new URL(window.location.href);
  const path=u.pathname.replace(/\/maintenance\.html$/, "/").replace(/\/$/,"/");
  u.pathname=path+"api/api.php"; u.search=""; return u.toString();
}
function getToken(){ return localStorage.getItem(LS_TOKEN)||""; }
function getApiUrl(){ return localStorage.getItem(LS_API)||defaultApiUrl(); }
async function api(action, body=null){
  const url=new URL(getApiUrl()); url.searchParams.set("action", action);
  const headers={"Content-Type":"application/json"}; const t=getToken(); if(t) headers["X-Auth-Token"]=t;
  const res=await fetch(url.toString(), {method: body?"POST":"GET", headers, body: body?JSON.stringify(body):undefined});
  const j=await res.json().catch(()=>null); if(!j||!j.ok) throw new Error(j&&j.error?j.error:"API error"); return j.data;
}
let cur=null;
function formatWhats(){
  const rooms=cur?.rooms||{};
  const list=Object.keys(rooms).filter(r=>rooms[r].maint && rooms[r].maint.active).sort();
  if(!list.length) return "‚úÖ Aucune maintenance active.";
  const lines=["üß∞ MAINTENANCE ‚Äî Liste"]; 
  list.slice(0,40).forEach(r=>{ const m=rooms[r].maint||{}; lines.push(`‚Ä¢ Room ${r} | ${(m.issue||"").trim()||"-"} | ${(m.status||"Ouvert")}`); });
  if(list.length>40) lines.push(`‚Ä¶ (+${list.length-40})`);
  lines.push(`\n‚û°Ô∏è Tickets technique: ouvrir /hk/tickets.html`);
  return lines.join("\n");
}
function render(){
  const tbody=$("body"); tbody.innerHTML="";
  const rooms=cur?.rooms||{};
  const list=Object.keys(rooms).filter(r=>rooms[r].maint && rooms[r].maint.active).sort();
  if(!list.length){
    const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="4" class="small">Aucune demande maintenance active.</td>`;
    tbody.appendChild(tr); return;
  }
  list.forEach(r=>{
    const m=rooms[r].maint||{};
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><b>${r}</b></td><td>${(m.issue||"").replace(/</g,"&lt;")}</td><td>${(m.status||"Ouvert")}</td><td>${(m.comment||"").replace(/</g,"&lt;")}</td>`;
    tbody.appendChild(tr);
  });
}
async function load(){
  try{
    cur = await api("get_current_state");
    $("statusMsg").innerHTML = `<span class="ok">‚úÖ API connect√©e</span>`;
  }catch(e){
    $("statusMsg").innerHTML = `<span class="warn">‚ö†Ô∏è API non disponible.</span>`;
    cur={rooms:{}};
  }
  render();
}
$("btnBack").addEventListener("click", ()=>{ window.location.href="index.html"; });
$("btnPrint").addEventListener("click", ()=>{ window.print(); });
$("btnRefresh").addEventListener("click", load);
$("btnWhats").addEventListener("click", ()=>{ window.open("https://wa.me/?text="+encodeURIComponent(formatWhats()),"_blank"); });
load();
</script>
</body>
</html>
