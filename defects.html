<!doctype html><html lang="fr"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>HK Defects</title>
<style>body{font-family:system-ui;margin:0;background:#0b0f14;color:#e7eef7}header{padding:12px 16px;border-bottom:1px solid #1e2a3b;position:sticky;top:0;background:#0b0f14}
a,button{color:#e7eef7}button{padding:10px 12px;border-radius:12px;border:1px solid #1e2a3b;background:#0b1220;cursor:pointer}
main{max-width:1200px;margin:0 auto;padding:16px;display:grid;grid-template-columns:360px 1fr;gap:12px}
@media(max-width:900px){main{grid-template-columns:1fr}}
.card{border:1px solid #1e2a3b;border-radius:14px;padding:14px;background:#111826}
input,select,textarea{width:100%;padding:9px 10px;border-radius:10px;border:1px solid #1e2a3b;background:#0b1220;color:#e7eef7}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #1e2a3b;font-size:12px;text-align:left}</style></head>
<body><header><b>Defect Log (HK)</b> ‚Äî <button onclick="location.href='index.html'">PMS</button> <button onclick="location.href='dashboard.html'">Dashboard</button> <button id="w">WhatsApp</button> <span id="s" style="opacity:.7;margin-left:8px"></span></header>
<main>
<section class="card"><b>Nouveau</b><div style="margin-top:10px">
<label>Room</label><input id="room" placeholder="214"></div><div style="margin-top:10px">
<label>Type</label><select id="type"><option>Poussi√®re</option><option>Odeur</option><option>Cheveux/SDB</option><option>Amenities</option><option>Sol</option><option>Vitres</option><option>Draps/linge</option><option selected>Autre</option></select></div>
<div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
<div><label>Gravit√©</label><select id="sev"><option>Low</option><option selected>Med</option><option>High</option></select></div>
<div><label>Statut</label><select id="st"><option selected>OPEN</option><option>FIXED</option></select></div></div>
<div style="margin-top:10px"><label>Note</label><textarea id="note" rows="3"></textarea></div>
<div style="margin-top:10px"><button id="add" style="background:#2d73ff;border-color:#2d73ff">Ajouter</button></div></section>
<section class="card"><div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
<div><b>Historique</b></div>
<div style="display:flex;gap:8px"><select id="f"><option value="ALL">Tous</option><option value="OPEN" selected>OPEN</option><option value="FIXED">FIXED</option></select><input id="fr" placeholder="Room" style="width:120px"></div></div>
<div style="margin-top:10px;overflow:auto"><table><thead><tr><th>Date</th><th>Room</th><th>Type</th><th>Sev</th><th>Statut</th><th>Note</th></tr></thead><tbody id="tb"></tbody></table></div></section>
</main>
<script>
const $=id=>document.getElementById(id); const LS_API="hk_api_url_v5";
const apiUrl=()=>localStorage.getItem(LS_API)||new URL("api/api.php",location.href).toString();
async function api(action,body=null){const u=new URL(apiUrl());u.searchParams.set("action",action);
const r=await fetch(u,{method:body?"POST":"GET",headers:{"Content-Type":"application/json"},body:body?JSON.stringify(body):undefined});
const j=await r.json().catch(()=>null); if(!j||!j.ok) throw new Error(j&&j.error?j.error:"API"); return j.data;}
let list=[];
function render(){const st=$("f").value, rr=$("fr").value.trim(); const tb=$("tb"); tb.innerHTML="";
const items=list.filter(d=>(st==="ALL"||(d.status||"OPEN")===st) && (!rr||String(d.room||"")===rr));
if(!items.length){tb.innerHTML='<tr><td colspan="6" style="opacity:.7">Aucun</td></tr>';return;}
items.forEach(d=>{const tr=document.createElement("tr"); tr.innerHTML=`<td>${(d.created_at||"").slice(0,16).replace("T"," ")}</td><td><b>${d.room||""}</b></td><td>${d.type||""}</td><td>${d.severity||""}</td><td>${d.status||""}</td><td>${(d.note||"").replace(/</g,"&lt;")}</td>`; tb.appendChild(tr);});}
function wa(){const open=list.filter(d=>(d.status||"OPEN")==="OPEN"); if(!open.length) return "‚úÖ Aucun defect OPEN.";
let t=["üßº HK ‚Äî DEFECTS OPEN"]; open.slice(0,40).forEach(d=>t.push(`‚Ä¢ Room ${d.room||"-"} | ${d.type||""} | ${d.severity||""} | ${(d.note||"").slice(0,40)}`)); return t.join("\n");}
async function load(){try{const d=await api("get_defects"); list=(d&&d.defects)||[]; $("s").textContent="‚úÖ API OK";}catch(e){list=[]; $("s").textContent="‚ö†Ô∏è API";} render();}
$("add").onclick=async()=>{const defect={room:$("room").value.trim(),type:$("type").value,severity:$("sev").value,status:$("st").value,note:$("note").value.trim()}; if(!defect.room) return;
try{await api("add_defect",{defect}); $("room").value=""; $("note").value=""; $("st").value="OPEN"; await load();}catch(e){}}
$("f").onchange=render; $("fr").oninput=render; $("w").onclick=()=>window.open("https://wa.me/?text="+encodeURIComponent(wa()),"_blank");
load();
</script></body></html>